---
title: "Responses to Assignment 4"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    highlight: haddock
    theme: cosmo
    number_sections: yes
  pdf_document:
    toc: yes
---

## Assignment Four: The Week Five Assignment {.unnumbered}

**`tidyr` and WIR2022**

-   Create an R Notebook of a Data Analysis containing the following and submit the rendered HTML file (e.g., `a3_123456.nb.html` by replacing 123456 with your ID)
    1.  create an R Notebook using the R Notebook Template in Moodle, save it as `a3_123456.Rmd`,
    2.  write your name and ID and the contents,
    3.  run each code block,
    4.  preview to create `a3_123456.nb.html`,
    5.  submit `a3_123456.nb.html` to Moodle.

1.  Choose data with at least two categorical variables and at least two numerical variables.

    -   Information of the data: Name, Indicator, Description, Source, etc.
    -   Explain why you chose the indicator
    -   List questions you want to study

2.  Explore the data using visualization using `ggplot2`.

    -   Create various charts
    -   Create at least one chart with at least two categorical variables and one numerical variable.
    -   Create at least one chart with at least two numerical and one categorical variable.

3.  Observations based on your data visualization and difficulties and questions encountered, if any.

**Due:** 2023-01-23 23:59:00. Submit your R Notebook file in Moodle (The Fourth Assignment). Due on Monday!

# Set up

```{r}
library(tidyverse)
library(WDI)
```

### World Development Indicator - WDI

The following is useful when you use WDI.

```{r cache = TRUE, eval = FALSE}
wdi_cache <- WDIcache()
```

Or, write the cache and read it from your computer.

```{r cache = TRUE, eval = FALSE}
write_rds(wdi_cache, "./data/wdi_cache")
```

```{r cache = TRUE}
wdi_cache <- read_rds("./data/wdi_cache")
```

`WDIcache()` produces a list containing two data frames: `wdi_cache$series` and `wdi_cache$country`.

```{r}
glimpse(wdi_cache)
```

### World Inequility Report - WIR2022

* World Inequality Report: https://wir2022.wid.world/
* Executive Summary: https://wir2022.wid.world/executive-summary/
* Methodology: https://wir2022.wid.world/methodology/
* Data URL: https://wir2022.wid.world/www-site/uploads/2022/03/WIR2022TablesFigures-Summary.xlsx

Please add `mode="wb"` (web binary). This should work better. 

```{r summary-data, cash = TRUE, eval = FALSE}
url_summary <- "https://wir2022.wid.world/www-site/uploads/2022/03/WIR2022TablesFigures-Summary.xlsx"
download.file(url = url_summary, destfile = "./data/WIR2022s.xlsx", mode = "wb") 
```

If you get an error, download the file directory from the methodology site, then open it with Excel and save it in the data folder of your R Studio project. Then R studio can recognize it easily as an Excel data.

```{r}
excel_sheets("./data/WIR2022s.xlsx")
```


# General Comments

## Reproducibility and Literate Programming

Reproducibility and Literate Programming are critical to exploratory data analysis (EDA). These are for communication; communication with readers of the paper, graders of the assignments, and communication with yourself, as we always forget. Please think about the reader of the article, and record the procedure and output so that reader can easily understand what you have done.

The data source is critical. Unless the reader obtains the same data quickly, the communication on EDA does not start. If the data is not downloaded automatically through the code chunk, you should explain how to obtain the data and the part of the data you applied. It is crucial when you use copying and paste using `read_delim(clipboard())`. Please describe the way for the reader to retrieve the same data easily. It is best to read your paper; in some cases, it can be a hard copy from the beginning to check whether the reader can reproduce what you have done in the article.

## Varibles

In this Assignment Four, we required the following:

-   Create at least one chart with at least two categorical variables and one numerical variable.
-   Create at least one chart with at least two numerical and one categorical variable.

You can create a simple chart, such as a histogram or a box plot with only one variable. If you have two variables, you can create a scatter plot. But with `ggplot2`, you can create various charts with rich information using more than two variables. For example, the year can be used for both numerical and categorical variables using `factor(year)` or recognized as a character vector by `as.character(year)`. So the distinction between categorical variables and numerical variables is flexible. The purpose of this assignment is to experience creating a chart with rich information using more than two variables.

However, I needed to clarify the variables' requirements for some of you. So I sent out an extra message from Announcement that you do not need to take it so strictly.

If you use WDI, the following may be examples:

-   two categorical and one numerical: a. country, region, and indicator; b. country, income, and indicator; c. after selecting a couple of years and using factor(year), country, indicator, d. create a table using group_by and summarize this type, etc.
-   two numerical and one categorical: a. year, indicator, and country; b. two indicators and region, etc.

If you use WIR, the following may be examples you saw in the executive summary:

-   two categorical and one numerical: F1, F2, F4, F13 (year in this case is categorical), F15

-   two numerical and one categorical: F6, F7, F10

-   Three categorical: F3

-   Two categorical and two numerical: F8, F11

## Visualization

Data visualization is a key to EDA. Create various charts and write your observations you can or cannot obtain the chart.

The following are the first two fundamental questions you keep in mind.

-   What type of variation occurs within my variables?
-   What type of covariation occurs between my variables?

# Your Work

## WIR2022

- F8: The rise of private versus the decline of public wealth in rich countries, 1970-2020
- WIR2022TablesFigures-Chapter6.xlsx: 
Historical and current emissions, Income and Population by world region

## Indicators Used in Assignment Three

- BX.KLT.DINV.CD.WD: Foreign Direct Investment (FDI) inflows
- NY.GDP.MKTP.CD: GDP (current US$)
- BX.TRF.PWKR.CD.DT: personal remittance
- NY.GNS.ICTR.ZS: gross savings
- NY.GDP.MKTP.KD.ZG: GDP Growth
- SE.XPD.TOTL.GB.ZS: government expenditure on educatio
- SE.PRM.UNER.FE", 
- "SE.PRM.UNER.MA
- EN.ATM.CO2E.KT: CO2 emissions (kt)
- BX.KLT.DINV.CD.WD: Foreign direct investment, net inflows (BoP, current US$)
- BN.CAB.XOKA.CD: Current account balance (BoP, current US$)
- NE.EXP.GNFS.KD: Exports of goods and services (constant 2015 US$)
- NE.IMP.GNFS.KD: Imports of goods and services (constant 2015 US$)
- SP.DYN.TFRT.IN:	Fertility rate, total (births per woman)
- SP.POP.GROW: Population growth (annual %)
- SE.ENR.PRSC.FM.ZS: School enrollment, primary and secondary (gross), gender parity index (GPI)


-   NY.GDP.PCAP.KD: GDP per capita (constant 2015 US\$)
-   NY.GDP.MKTP.CD: GDP (current US\$)
-   NY.GDP.PCAP.KD.ZG: GDP per capita growth (annual%)
-   SP.POP.TOTL: Total Population
-   IP.JRN.ARTC.SC: Scientific and technical journal articles
-   FP.CPI.TOTL.ZG: Inflation, consumer prices (% annual growth)
-   DT.ODA.ODAT.PC.ZS: Net ODA received per capita (current US\$)
-   BX.KLT.DINV.CD.WD: Foreign direct investment, net inflows (BoP, current US\$)
-   MS.MIL.XPND.GD.ZS: Military expenditure (% of GDP)
-   MS.MIL.TOTL.P1: Total Armed Forces Personnel
-   SI.POV.MDIM: Multidimensional poverty headcount ratio (% of total population)
-   SI.POV.NAHC: Poverty headcount ratio at national poverty lines (% of population)
-   SI.POV.GINI: Gini index
-   NY.GNS.ICTR.ZS: Gross savings (% of GDP)
-   SL.UEM.TOTL.ZS: Unemployment, total (% of total labor force) (modeled ILO estimate)
-   SP.URB.TOTL.IN.ZS (Urban population (% of total population))
-   AG.LND.AGRI.ZS: Agricultural land (% of land area)
-   SE.ADT.LITR.FE.ZS: Literacy rate, adult female (% of females ages 15 and above))
-   SE.ADT.LITR.MA.ZS: Literacy rate, adult male (% of males ages 15 and above))
-   SE.ADT.LITR.ZS: Literacy rate, adult total
-   SE.ADT.1524.LT.FE.ZS: Literacy rate, youth female (% of females ages 15-24)
-   SE.XPD.TOTL.GD.ZS: Government expenditure on education, total (% of GDP)
-   SG.GEN.PARL.ZS: Proportion of seats held by women in national parliaments (%)

## UN

- Education: "https://data.un.org/_Docs/SYB/CSV/SYB65_309_202209_Education.csv"
- Population: "https://data.un.org/_Docs/SYB/CSV/SYB65_246_202209_Population%20Growth,%20Fertility%20and%20Mortality%20Indicators.csv"


# Responses to Questions

## Q. WIR2022, F8 with a fixed year, say 2020 describing the difference of goevernment and privata income.

```{r data-f1, cash = TRUE, message = FALSE}
df_f8 <- read_excel("./data/WIR2022s.xlsx", sheet = "data-F8")
df_f8
```

```{r}
df_f8 %>% filter(year == "2020") %>%
  select(year, Germany_public = Germany, Germany_private = 'Germany (private)', 
         Spain_public = Spain, Spain_private = 'Spain (private)', 
         France_public = France, France_private = 'France (private)', 
         UK_public  = UK, UK_private = 'UK (private)', 
         Japan_public = Japan, Japan_private = 'Japan (private)', 
         Norway_public = Norway, Norway_private = 'Norway (private)',
         USA_public = USA, USA_private = 'USA (private)') %>%
  pivot_longer(!year, names_to = c("country",".value"), names_sep = "_") %>%
  pivot_longer(3:4, names_to = "type", values_to = "value")
```

Then, in this case, geom_col seems to fit.

```{r}
df_f8 %>% filter(year == "2020") %>%
  select(year, Germany_public = Germany, Germany_private = 'Germany (private)', 
         Spain_public = Spain, Spain_private = 'Spain (private)', 
         France_public = France, France_private = 'France (private)', 
         UK_public  = UK, UK_private = 'UK (private)', 
         Japan_public = Japan, Japan_private = 'Japan (private)', 
         Norway_public = Norway, Norway_private = 'Norway (private)',
         USA_public = USA, USA_private = 'USA (private)') %>%
  pivot_longer(!year, names_to = c("country",".value"), names_sep = "_") %>%
  pivot_longer(3:4, names_to = "type", values_to = "value") %>%
  ggplot() +
  geom_col(aes(x = country, y = value, fill = type), position = "dodge") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Private versus public wealth in rich countries in 2020", 
       x = "", y = "wealth as as % of national income", color = "", type = "")
```


Can you ind a similar data of other countries of this type?

It is in Chapter 3 of the report:

https://wir2022.wid.world/chapter-3/

From methodology, I explained on January 25, you can download the data for chapter three: WIR2022TablesFigures-Chapter3.xlsx

### Q. The line graph looked strange at first and I couldn’t really see the results clearly. However, I could solve that problem by using “smoothstat” and then the results looked way better and I was able to interpret them easily.

* WDI indicator: BX.KLT.DINV.CD.WD: Foreign Direct Investment (FDI) inflows

```{r}
df_fdi <- WDI(country = "all", indicator = c(fdi = "BX.KLT.DINV.CD.WD"), start =1970 , extra = TRUE, cache = NULL) %>% drop_na(fdi)
df_fdi
```

```{r}
unique(df_fdi$country)
```

```{r}
df_dfi %>% ggplot(aes(x=year, y=fdi, color=income)) + geom_line()
```

We obseve several problems. But the largest problem is it looks line a sawtooth. It is because,  there are so many y values at the same x value. When you draw line graph, you need to choose only several countries or using group_by and summarize and use summarized data. However, there is an option, we can use a model to summarize the data of each group using geom_smooth(). Since you do not want a line but a curve, we use "loess" and spa, we used to draw some of WIR2022 charts.

```{r}
df_fdi %>% drop_na(income) %>% 
  filter(!income %in% c("aggregates","Not classified")) %>%
  ggplot(aes(x=year,y=fdi,color=income)) + 
  geom_smooth(formula = y~x, method = "loess", span = 0.25, se = FALSE)
```

It may be a good choice to use `scale_y_log10()`. However, since log10(0) is not finite, you need to choose those with the indicator positive.

```{r}
df_fdi %>% filter(!income %in% c(NA, "Aggregates")) %>% filter(fdi == 0) %>%
  ggplot(aes(x = income, fill = income)) + geom_bar() + 
  labs(title = "Number of Countries with FDI = 0") +
  theme(legend.position = "none")
```


```{r}
df_fdi %>% drop_na(income) %>% filter(fdi > 0) %>%
  filter(!income %in% c("aggregates","Not classified")) %>%
  ggplot(aes(x=year,y=fdi,color=income)) + 
  geom_smooth(formula = y~x, method = "loess", span = 0.25, se = FALSE) +
  scale_y_log10() + labs(title="The Value FID = 0 Excluded")
```

Q. Position of the labels

```{r}
# choose colors from: http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/
# or rgb from: https://www.rapidtables.com/web/color/RGB_Color.html
color_list <- c("#00AE9D","#F58220","#6C676E")
df_f1 <- read_excel("./data/WIR2022s.xlsx", sheet = "data-F1")

df_f1_rev <- pivot_longer(df_f1, -1, names_to = "group", values_to = "value")

df_f1_rev[df_f1_rev$group != "Top 1%",] %>%
  ggplot(aes(x = ...1, y = value, fill = group)) -> g
g + geom_col(position = "dodge", width = 0.8) + 
  scale_fill_manual(values = color_list) +
  labs(title="Fig.1: Global income and wealth inequality, 2021", x="", y="Share of total income or wealth",fill="Group") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_text(aes(x = ...1, y = value+0.03, group = group, 
            label = scales::label_percent(accuracy=1)(value)), 
            position = position_dodge(width = 0.8))  
```

```{r}
color_list <- c("#00AE9D","#F58220","#6C676E","#FAC61E","#90D7EC","#91BA58","#33CC99")
df_f1 <- read_excel("./data/WIR2022s.xlsx", sheet = "data-F1")

pivot_longer(df_f1, -1, names_to = "group", values_to = "value") -> df_f1_rev

df_f1_rev[df_f1_rev$group != "Top 1%",] %>%
  ggplot(aes(x = ...1, y = value, fill = group)) -> g
  g <- g + geom_col(position = "dodge", width = 0.8)
  g <- g + scale_fill_manual(values = color_list)
  g <- g + labs(title="Fig.1: Global income and wealth inequality, 2021", x="", y="Share of total income or wealth",fill="Group")
  g <- g + scale_y_continuous(labels = scales::percent_format(accuracy = 1))
#  g <- g + theme(
#    legend.position = c(0.2, 0.95),
#    legend.justification = c(1, 1),
#    legend.background = element_rect(fill = "white", colour = "black"))
  g <- g + geom_text(aes(x = ...1, y = value+0.03, group = group, 
            label = scales::label_percent(accuracy=1)(value)), 
            position = position_dodge(width = 0.8))  
  g
```

Q. How is it possible to organize better the name of the value in the x axis so that they are better readable?

Q. Long Labels


### UN 

#### Education

```{r}
"https://data.un.org/_Docs/SYB/CSV/SYB65_309_202209_Education.csv"
un_edu <- read_csv(url, skip = 1)
```
```{r}
un_edu
```

```{r}
un_edu %>% distinct(...2) %>% pull()
```

```{r}
unique(un_ed$Series)
```
```{r}
unique(un_ed$Source)
```

#### Populaion

```{r}
url_un_popu = "https://data.un.org/_Docs/SYB/CSV/SYB65_246_202209_Population%20Growth,%20Fertility%20and%20Mortality%20Indicators.csv"
df_un_popu <- read.csv(url_un_popu)
df_un_popu
```

###

```{r}
df_wdi_compoverty <- WDI(
  country = "all", 
  indicator = c(lifeExp = "SP.DYN.LE00.IN", gdpPercap = "NY.GDP.PCAP.KD", gini="SI.POV.GINI"), start = 1990, end = 2021, extra = TRUE, cache =  wdi_cache)
```


```{r}
df_wdi_compoverty
```

```{r}
df_wdi_compoverty %>%
  filter(year %in% c("1988", "1998", "2008", "2018")) %>%
  filter(country %in% c("Afghanistan", "Israel", "Azerbaijan", "Austria", "Australia")) %>%
  ggplot(aes(x=year)) +
  geom_boxplot(aes(y=lifeExp, color=country)) +  labs(title = "Life expectency in select countries", subtitle="at ten year gaps: 1988, 1998, 2008, 2018")
```

```{r}
df_wdi_compoverty %>%
  filter(year %in% c(1988, 1998, 2008, 2018)) %>%
  filter(country %in% c("Afghanistan", "Israel", "Azerbaijan", "Austria", "Australia")) %>%
  ggplot(aes(x=factor(year))) +
  geom_boxplot(aes(y=lifeExp, fill=country)) +  labs(title = "Life expectency in select countries", subtitle="at ten year gaps: 1988, 1998, 2008, 2018", x = "year")
```


```{r}
df_wdi_compoverty %>%
  filter(year %in% c(1988, 1998, 2008, 2018)) %>%
  filter(country %in% c("Afghanistan", "Israel", "Azerbaijan", "Austria", "Australia")) %>%
  ggplot(aes(x=factor(year), y=lifeExp, fill=country)) +
  geom_col(position = "dodge", col = "black") +
  labs(x = "year")
```

```{r}
df_wdi_compoverty %>% drop_na(lifeExp) %>%
   filter(!is.na(region)) %>%  filter(!(region=="Aggregates")) %>%
   filter(year %in% c(1990, 2005, 2020)) %>%
   ggplot(aes(x=factor(year), y=lifeExp, fill=region)) +
  geom_boxplot() +  labs(title = "Life expectency by region", subtitle="1990, 2005, 2020", x = "year")
```

### UN Population

```{r}
url_un_popu = "https://data.un.org/_Docs/SYB/CSV/SYB65_246_202209_Population%20Growth,%20Fertility%20and%20Mortality%20Indicators.csv"
df_un_popu <- read_csv(url_un_popu)
df_un_popu
```

```{r}
df_un_popu %>%
  pivot_wider(names_from = X.1, values_from = X.2)
```


### CO2

```{r}
wdi_co2 <- WDI(country = "all", indicator = c(rate = "EN.ATM.CO2E.KT"), start = 1990, extra = TRUE)
```

```{r}
wdi_co2 %>% drop_na(rate) %>% filter(rate >0) %>% filter(!income %in% c("Aggregates", "Not classified", NA), year == 2019) %>%
  ggplot(aes(x = income, y = rate, color = income)) + scale_y_log10() + 
  geom_jitter(width = 0.2) + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15))
```


```{r}
df_F6.3b <- read_excel("data/WIR2022TablesFigures-Chapter6.xlsx",sheet = "data-F6.3b" );df_F6.3b
```

```{r}
df_Climate <- read_excel("data/Climate.xlsx",sheet = "Sheet3" );df_Climate
```

### Fertility Rate

```{r}
dat_extra <- WDI(country = "all",
    indicator = "SP.DYN.TFRT.IN",
    start = 1960,
    end = 2020,
    extra = TRUE
   )
dat_extra
```

```{r}
dat_extra %>% drop_na(SP.DYN.TFRT.IN) %>% filter(!income %in% c("Aggregates", NA, "Not classified"), year == 2020) %>%
  arrange(desc(SP.DYN.TFRT.IN))
```
```{r}
dat_extra %>% drop_na(SP.DYN.TFRT.IN) %>% filter(!income %in% c("Aggregates", NA, "Not classified"), year == 2020) %>%
  arrange(SP.DYN.TFRT.IN)
```
```{r}
dat_extra %>% drop_na(SP.DYN.TFRT.IN) %>% filter(!income %in% c("Aggregates", NA, "Not classified"), year == 2020) %>% ggplot(aes(region, SP.DYN.TFRT.IN, fill = region)) + geom_boxplot() + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +
  labs(x = "") + theme(legend.position = "none")
```


### Population Growth

```{r}
worldpop <- WDI(country = "all", indicator = "SP.POP.GROW", start = 1961, end = NULL, extra = TRUE, cache = wdi_cache) 
```

```{r}
worldpop %>% filter(region %in% c("World", "", "East Asia & Pacific", "Latin America & Caribbean", "Middle East & North Africa" ) & (year ==2021)) %>%
  ggplot(aes(x = income, y = SP.POP.GROW, color = region, shape = income)) + 
  geom_jitter()
```

```{r}
worldpop %>% filter(region %in% c("World", "", "East Asia & Pacific", "Latin America & Caribbean", "Middle East & North Africa" ) & (year ==2021)) %>% filter(income != "Not classified") %>%
  ggplot(aes(x = region, y = SP.POP.GROW, fill = income)) + 
  geom_boxplot() + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +
  labs(x = "")
```

```{r}
worldpop %>% drop_na(SP.POP.GROW) %>%
  filter(!income %in% c("Aggregates", NA, "Not classified")) %>% 
  ggplot() + geom_smooth(aes(x = year, y = SP.POP.GROW, color = income), formula = y~x, method = "loess", se = FALSE)
```

